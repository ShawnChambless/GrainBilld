var express=require("express"),app=express(),session=require("express-session"),mongoose=require("mongoose"),passport=require("passport"),FacebookStrategy=require("passport-facebook").Strategy,TwitterStrategy=require("passport-twitter").Strategy,GoogleStrategy=require("passport-google-oauth2").Strategy,User=require("./models/users/userModel"),UserCtrl=require("./controllers/users/userCtrl"),port=8081,bodyParser=require("body-parser"),grainCtrl=require("./controllers/database/grainCtrl"),hopsCtrl=require("./controllers/database/hopsCtrl"),yeastCtrl=require("./controllers/database/yeastCtrl"),LocalStrategy=require("passport-local").Strategy;cors=require("cors"),app.use(bodyParser.json()),app.use(cors()),app.use(passport.initialize()),app.use(passport.session());var isAuthed=function(e,t,s){return e.isAuthenticated()?s():t.sendStatus(401)};app.use(session({secret:"gibberish",resave:!1,saveUninitialized:!1})),passport.use(new LocalStrategy({usernameField:"email",passwordField:"password",passReqToCallback:!0,session:!0},function(e,t,s){User.findOne({email:e}).exec(function(e,a){return e&&s(e),a&&a.verifyPassword(t)?s(null,a):s(null,!1)})})),passport.use(new FacebookStrategy({clientID:"382558321950904",clientSecret:"a09fff493ed129f076a75d5f85d33562",callbackURL:"http://localhost:5757/",enableProof:!1},function(e,t,s,a){console.log("anything plz"),a(null,user)})),passport.serializeUser(function(e,t){t(null,e._id)}),passport.deserializeUser(function(e,t){User.findById(e,function(e,s){t(e,s)})}),app.get("/database/ingredients/grain",grainCtrl.getGrain),app.post("/database/ingredients/grain",grainCtrl.addGrain),app.put("/database/ingredients/grain/:_id",grainCtrl.updateGrain),app.get("/database/ingredients/hops",hopsCtrl.getHops),app.post("/database/ingredients/hops",hopsCtrl.addHops),app.get("/database/ingredients/yeast",yeastCtrl.getYeast),app.post("/database/ingredients/yeast",yeastCtrl.addYeast),app.get("/auth/facebook",passport.authenticate("facebook")),app.get("/auth/facebook/callback",passport.authenticate("facebook",{successRedirect:"http://localhost:5757/",failureRedirect:"http://localhost:5757/#/database"})),app.post("/register/user",UserCtrl.register),app.get("/user",isAuthed,UserCtrl.me),app.put("/user",isAuthed,UserCtrl.update),app.post("/auth/local",passport.authenticate("local",{successRedirect:"http://localhost:5757/"})),app.get("/logout",function(e,t){return e.logout(),t.redirect("http://localhost:5757/"),t.send("logged out")}),app.listen(port,function(){console.log("Listening on",port)}),mongoose.connect("mongodb://localhost:27017/brewabatch",function(e,t){console.log(e,"Mongo is also Listening")});